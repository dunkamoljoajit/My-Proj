<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>การแจ้งเตือน - ระบบจัดตารางเวร</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="components.js"></script> 

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .card-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="pb-24">

    <app-header></app-header>

    <main class="max-w-3xl mx-auto px-4 py-6 sm:py-8">
        
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
            <div>
                <h1 class="text-xl sm:text-2xl font-bold text-slate-800 flex items-center gap-2">
                    <i class="fas fa-bell text-indigo-600 text-lg sm:text-xl"></i> การแจ้งเตือน
                </h1>
                <p class="text-slate-500 text-xs sm:text-sm mt-1" id="page-subtitle">จัดการรายการคำขอที่เข้ามา</p>
            </div>

            <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-xl shadow-sm border border-slate-200 w-full md:w-auto">
                <i class="fas fa-filter text-slate-400 text-xs"></i>
                <select id="filterType" class="bg-transparent text-xs sm:text-sm text-slate-600 outline-none border-none focus:ring-0 cursor-pointer w-full" onchange="filterNotifications()">
                    <option value="all">ทั้งหมด</option>
                    <option value="buy">ซื้อขายเวร</option>
                    <option value="swap">แลกเปลี่ยนเวร</option>
                    <option value="system">แจ้งเพื่อทราบ</option>
                </select>
            </div>
        </div>

        <div id="loading" class="hidden flex-col items-center justify-center py-20">
            <div class="w-10 h-10 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
            <span class="text-slate-400 text-xs font-medium tracking-wide">กำลังดึงข้อมูลล่าสุด...</span>
        </div>

        <div id="notificationList" class="space-y-4"></div>

        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-24 text-center">
            <div class="w-16 h-16 sm:w-20 sm:h-20 bg-slate-50 rounded-full flex items-center justify-center mb-5 border border-slate-100">
                <i class="fas fa-check-circle text-3xl sm:text-4xl text-slate-200"></i>
            </div>
            <h3 class="text-base sm:text-lg font-bold text-slate-600">ไม่มีรายการใหม่</h3>
            <p class="text-slate-400 text-xs sm:text-sm mt-1">คุณจัดการคำขอทั้งหมดเรียบร้อยแล้ว</p>
        </div>

    </main>

    <app-navbar></app-navbar>

    <script>
        let allNotifications = []; 
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', () => {
            currentUser = getUser();
            if (!currentUser) { window.location.href = 'login.html'; return; }
            if (currentUser.RoleID === 1) {
                document.getElementById('page-subtitle').innerText = 'รายการรออนุมัติ (หัวหน้าพยาบาล)';
            }
            loadNotifications();
        });

        async function markAllAsRead() {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_BASE}/api/notifications/mark-all-read`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ userId: currentUser.UserID })
                });
                if (res.ok) {
                    const header = document.querySelector('app-header');
                    if (header && header.fetchBadgeCount) { header.fetchBadgeCount(currentUser); }
                }
            } catch (err) { console.error("Mark Read Error:", err); }
        }

        async function loadNotifications() {
            const list = document.getElementById('notificationList');
            const loader = document.getElementById('loading');
            const empty = document.getElementById('emptyState');
            loader.classList.remove('hidden');
            list.innerHTML = '';
            empty.classList.add('hidden');

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_BASE}/api/notifications/all/${currentUser.UserID}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                loader.classList.add('hidden');
                if (!data.success || data.notifications.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                allNotifications = data.notifications;
                renderList(allNotifications);
                markAllAsRead();
            } catch (err) {
                console.error("Fetch Error:", err);
                loader.classList.add('hidden');
                Swal.fire('ข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้', 'error');
            }
        }

        function renderList(data) {
            const list = document.getElementById('notificationList');
            const empty = document.getElementById('emptyState');
            list.innerHTML = '';
            if (data.length === 0) { empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');

            data.forEach((noti, index) => {
                const isBuy = noti.type === 'buy';
                const isSystem = noti.type === 'system';
                
                let theme = isSystem ? { borderColor: 'border-blue-400', bgIcon: 'bg-blue-50 text-blue-500', icon: 'fa-check-double', label: 'สถานะ', badgeColor: 'bg-blue-50 text-blue-600', badgeText: 'สำเร็จ' } :
                            isBuy ? { borderColor: 'border-emerald-400', bgIcon: 'bg-emerald-50 text-emerald-500', icon: 'fa-shopping-cart', label: 'เสนอราคา', badgeColor: 'bg-emerald-50 text-emerald-600', badgeText: 'ซื้อขาย' } :
                                    { borderColor: 'border-orange-400', bgIcon: 'bg-orange-50 text-orange-500', icon: 'fa-exchange-alt', label: 'เหตุผล', badgeColor: 'bg-orange-50 text-orange-600', badgeText: 'แลกเปลี่ยน' };

                const dateObj = new Date(noti.created_at);
                const timeStr = dateObj.toLocaleString('th-TH', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' });

                let shiftDateStr = 'ไม่ระบุวันที่';
                if (noti.ShiftDate && noti.ShiftDate !== 'Invalid Date') {
                    const sDate = new Date(noti.ShiftDate);
                    if (!isNaN(sDate)) { shiftDateStr = sDate.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' }); }
                }

                const html = `
                <div class="card-enter bg-white rounded-2xl shadow-sm border border-slate-100 p-4 sm:p-5 relative overflow-hidden group hover:shadow-md transition-all" style="animation-delay: ${index * 0.05}s">
                    <div class="absolute left-0 top-0 bottom-0 w-1 ${theme.borderColor}"></div>
                    
                    <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                        <div class="flex-shrink-0 flex items-start justify-between sm:block">
                            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl ${theme.bgIcon} flex items-center justify-center border border-slate-50 shadow-sm">
                                <i class="fas ${theme.icon} text-base sm:text-lg"></i>
                            </div>
                            <span class="sm:hidden px-2 py-0.5 rounded-lg text-[10px] font-bold uppercase tracking-wider ${theme.badgeColor}">${theme.badgeText}</span>
                        </div>

                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start mb-1">
                                <div>
                                    <h3 class="font-bold text-slate-800 text-sm sm:text-base leading-tight">${isSystem ? noti.LastName : (isBuy ? 'คำขอซื้อเวร' : 'คำขอแลกเวร')}</h3>
                                    <p class="text-[10px] text-slate-400 mt-0.5"><i class="far fa-clock mr-1"></i> ${timeStr}</p>
                                </div>
                                <span class="hidden sm:inline-block px-2.5 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider ${theme.badgeColor}">${theme.badgeText}</span>
                            </div>

                            <div class="mt-3 bg-slate-50/50 rounded-xl p-3 border border-slate-100">
                                <p class="text-xs text-slate-500 mb-2">แจ้งโดย: <span class="font-bold text-slate-700">${noti.FirstName}</span></p>
                                <div class="flex items-center gap-2 text-xs text-slate-600">
                                    <i class="far fa-calendar-alt text-indigo-400"></i>
                                    <span class="font-medium">${noti.ShiftName || 'ไม่ระบุเวร'}</span>
                                    <span class="text-slate-300">|</span>
                                    <span class="text-slate-500">${shiftDateStr}</span>
                                </div>
                            </div>

                            <div class="mt-3 flex items-baseline gap-2">
                                <span class="text-[10px] font-bold text-slate-400 uppercase">${theme.label}:</span>
                                <span class="text-xs sm:text-sm ${isBuy ? 'text-emerald-600 font-bold' : 'text-slate-600 italic'}">${isBuy ? '฿'+noti.info : noti.info}</span>
                            </div>
                        </div>
                    </div>

                    ${!isSystem ? `
                    <div class="mt-5 pt-4 border-t border-slate-50 flex flex-col sm:flex-row gap-2 justify-end">
                        <button onclick="handleAction('${noti.type}', ${noti.id}, 'reject')" class="w-full sm:w-auto px-5 py-2.5 rounded-xl text-xs sm:text-sm font-bold text-red-500 hover:bg-red-50 transition-colors order-2 sm:order-1">ปฏิเสธ</button>
                        <button onclick="handleAction('${noti.type}', ${noti.id}, 'approve')" class="w-full sm:w-auto px-6 py-2.5 rounded-xl text-xs sm:text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 shadow-md transform active:scale-95 transition-all order-1 sm:order-2">อนุมัติ</button>
                    </div>
                    ` : `<div class="mt-4 pt-3 border-t border-slate-50 flex justify-end"><span class="text-[9px] sm:text-[10px] text-slate-400 font-medium"><i class="fas fa-info-circle mr-1"></i> ดำเนินการเสร็จสิ้น</span></div>`}
                </div>`;
                list.insertAdjacentHTML('beforeend', html);
            });
        }

        async function handleAction(type, id, action) {
            const confirm = await Swal.fire({
                title: `ยืนยันการ${action === 'approve' ? 'อนุมัติ' : 'ปฏิเสธ'}?`,
                icon: action === 'approve' ? 'question' : 'warning',
                showCancelButton: true,
                confirmButtonColor: action === 'approve' ? '#4f46e5' : '#ef4444',
                confirmButtonText: 'ยืนยัน',
                cancelButtonText: 'ยกเลิก',
                customClass: { popup: 'rounded-3xl', confirmButton: 'rounded-xl px-6', cancelButton: 'rounded-xl' }
            });
            if (!confirm.isConfirmed) return;

            let url, body;
            const isHead = currentUser.RoleID === 1;
            if (isHead) {
                url = type === 'buy' ? `${API_BASE}/api/admin/market/action` : `${API_BASE}/api/admin/swaps/action`;
                body = { [type === 'buy' ? 'transactionId' : 'swapId']: id, action, adminId: currentUser.UserID };
            } else {
                url = type === 'buy' ? `${API_BASE}/api/market/seller-respond` : `${API_BASE}/api/swaps/respond`;
                body = { [type === 'buy' ? 'transactionId' : 'swapId']: id, action, responderId: currentUser.UserID };
            }

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(body)
                });
                const result = await res.json();
                if (res.ok && result.success) {
                    Swal.fire({ title: 'สำเร็จ', text: result.message, icon: 'success', customClass: { popup: 'rounded-3xl' } }).then(() => {
                        loadNotifications();
                        const header = document.querySelector('app-header');
                        if (header && header.fetchBadgeCount) { header.fetchBadgeCount(currentUser); }
                    });
                } else { Swal.fire('เกิดข้อผิดพลาด', result.message, 'error'); }
            } catch (err) { Swal.fire('Connection Error', 'ไม่สามารถเชื่อมต่อ Server ได้', 'error'); }
        }

        function filterNotifications() {
            const type = document.getElementById('filterType').value;
            renderList(type === 'all' ? allNotifications : allNotifications.filter(n => n.type === type));
        }
    </script>
</body>
</html>