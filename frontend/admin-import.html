<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ - Admin</title>
    <link href="./style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <script src="components.js"></script> <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body class="text-slate-800 antialiased bg-[#f0fdfa]" style="background-image: url('background06.png'); background-size: cover; background-attachment: fixed;">

    <div class="flex flex-col min-h-screen">
        
       <app-header></app-header>

        <main class="flex-1 w-full max-w-4xl mx-auto p-4 md:p-6 pb-32 animate-fade-in">
            
            <div class="mb-6 flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</h1>
                    <p class="text-slate-500 text-sm">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</p>
                </div>
                <a href="template_users.xlsx" download class="hidden sm:flex items-center text-indigo-600 text-sm hover:underline">
                    <i class="fas fa-file-download mr-2"></i> ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                </a>
            </div>

            <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-lg border border-indigo-100 p-8 text-center">
                
                <div id="drop-zone" class="border-3 border-dashed border-indigo-200 rounded-2xl p-10 bg-indigo-50/50 hover:bg-indigo-50 transition-colors cursor-pointer group relative">
                    <input type="file" id="fileInput" accept=".xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                    
                    <div class="flex flex-col items-center justify-center space-y-4 pointer-events-none">
                        <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform">
                            <i class="fas fa-file-excel text-3xl text-green-600"></i>
                        </div>
                        <div>
                            <p class="text-lg font-bold text-slate-700 group-hover:text-indigo-600 transition">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p>
                            <p class="text-sm text-slate-400">‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ .xlsx)</p>
                        </div>
                        <p id="fileNameDisplay" class="text-indigo-600 font-medium text-sm hidden"></p>
                    </div>
                </div>

                <div class="mt-6 flex justify-center gap-4">
                    <button onclick="uploadFile()" class="px-8 py-3 bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-xl shadow-lg hover:shadow-indigo-200 hover:-translate-y-1 transition-all font-bold flex items-center">
                        <i class="fas fa-cloud-upload-alt mr-2"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
                    </button>
                </div>

            </div>

            <div id="result-area" class="hidden mt-8">
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                        <h3 class="font-bold text-lg text-slate-800">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                        <span id="timestamp-display" class="text-xs text-slate-400"></span>
                    </div>
                    
                    <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="p-4 bg-blue-50 rounded-2xl border border-blue-100">
                            <p class="text-sm text-blue-600 mb-1">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                            <p id="stat-total" class="text-3xl font-bold text-blue-800">0</p>
                        </div>
                        <div class="p-4 bg-green-50 rounded-2xl border border-green-100">
                            <p class="text-sm text-green-600 mb-1">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
                            <p id="stat-success" class="text-3xl font-bold text-green-800">0</p>
                        </div>
                        <div class="p-4 bg-red-50 rounded-2xl border border-red-100">
                            <p class="text-sm text-red-600 mb-1">‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>
                            <p id="stat-failed" class="text-3xl font-bold text-red-800">0</p>
                        </div>
                    </div>

                    <div id="error-list-container" class="hidden">
                        <div class="px-6 pb-2">
                            <p class="text-sm font-bold text-red-500 mb-2"><i class="fas fa-exclamation-circle mr-1"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</p>
                        </div>
                        <div class="max-h-60 overflow-y-auto bg-slate-50 border-t border-slate-100">
                            <ul id="error-list" class="divide-y divide-slate-200 text-sm text-slate-600">
                                </ul>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <app-navbar></app-navbar>
    </div>

    <script>


        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin
        const user = JSON.parse(localStorage.getItem('user'));

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡∏´‡∏£‡∏∑‡∏≠ RoleID ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 1
        if (!user || user.RoleID !== 1) {
            Swal.fire({
                icon: 'error',
                title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ',
                text: '‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                showConfirmButton: false,
                timer: 2000
            }).then(() => {
                window.location.href = 'dashboard.html'; // üëâ ‡∏î‡∏µ‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Dashboard ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            });
        }

        // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Input File (Visual)
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const dropZone = document.getElementById('drop-zone');

        fileInput.addEventListener('change', (e) => {
            if(e.target.files.length > 0) {
                const name = e.target.files[0].name;
                fileNameDisplay.textContent = `‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${name}`;
                fileNameDisplay.classList.remove('hidden');
                dropZone.classList.add('border-indigo-500', 'bg-indigo-100');
            }
        });

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Upload
        async function uploadFile() {
            const files = fileInput.files;
            if (files.length === 0) {
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', 'warning');
                return;
            }

            const formData = new FormData();
            formData.append('file', files[0]);

            // Show Loading
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...',
                html: '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const token = localStorage.getItem('authToken');
                const res = await fetch(`${API_BASE}/api/admin/import-users`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}` // ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà Content-Type: multipart/form-data ‡πÄ‡∏≠‡∏á‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î
                    },
                    body: formData
                });

                const data = await res.json();

                if (res.status === 401 || res.status === 403) {
                    throw new Error('‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡πà‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á');
                }

                if (data.success) {
                    Swal.close();
                    displayResult(data);
                    Swal.fire({
                        icon: 'success',
                        title: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                        text: data.message,
                        timer: 2000
                    });
                } else {
                    throw new Error(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }

            } catch (err) {
                console.error(err);
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message, 'error');
            }
        }

        // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        function displayResult(data) {
            const area = document.getElementById('result-area');
            const summary = data.summary;
            const errors = data.errors || [];

            document.getElementById('stat-total').innerText = summary.total;
            document.getElementById('stat-success').innerText = summary.success;
            document.getElementById('stat-failed').innerText = summary.failed;
            document.getElementById('timestamp-display').innerText = new Date().toLocaleString('th-TH');

            const errorListContainer = document.getElementById('error-list-container');
            const errorList = document.getElementById('error-list');
            errorList.innerHTML = '';

            if (errors.length > 0) {
                errorListContainer.classList.remove('hidden');
                errors.forEach(err => {
                    const li = document.createElement('li');
                    li.className = 'px-6 py-3 hover:bg-red-50 flex items-start gap-2';
                    li.innerHTML = `<i class="fas fa-times-circle text-red-400 mt-0.5"></i> <span>${err}</span>`;
                    errorList.appendChild(li);
                });
            } else {
                errorListContainer.classList.add('hidden');
            }

            area.classList.remove('hidden');
            // Scroll ‡∏•‡∏á‡∏°‡∏≤‡∏î‡∏π‡∏ú‡∏•
            area.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>