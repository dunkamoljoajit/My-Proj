<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>สถิติการทำงาน - AutoNurseShift</title>
    
    <link href="./style.css" rel="stylesheet">

    <link rel="stylesheet" href="./lib/fontawesome/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/th.min.js"></script>

    <script src="components.js"></script> 
    
    <style>
        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: #f0f4f8;
            background-image: url('background06.png'); 
            background-size: cover; 
            background-position: center;
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent; 
            color: #1e293b;
            overscroll-behavior: none;
        }
        .color-shift-a { color: #22c55e; font-weight: 600; }
        .color-shift-b { color: #f97316; font-weight: 600; }
        .color-shift-c { color: #3b82f6; font-weight: 600; }
        .weekly-detail-row { background-color: #f8fafc; animation: slideDown 0.3s ease-out; border-bottom: 1px solid #e2e8f0; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { overscroll-behavior-y: none; }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">

    <app-header class="sticky top-0 z-30"></app-header>
    <app-layout>
        
        <div class="-mt-28 sm:-mt-10 relative z-0 w-full max-w-7xl mx-auto px-2 sm:px-6">
            
            <div class="flex items-center justify-between mb-2 pt-0">
                <div>
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <span class="bg-indigo-600 text-white rounded-full w-7 h-7 flex items-center justify-center shadow-md">
                            <i class="fas fa-chart-pie text-xs"></i>
                        </span>
                        สถิติการทำงาน
                    </h2>
                    <p class="text-slate-500 text-[10px] mt-0.5 ml-1 font-medium pl-9 -mt-1">สรุปข้อมูลการขึ้นเวรและแลกเปลี่ยน</p>
                </div>
                
                <div class="relative">
                    <i class="fas fa-calendar-alt absolute left-2.5 top-1/2 -translate-y-1/2 text-indigo-500 pointer-events-none text-xs"></i>
                    <select id="yearSelector" class="pl-7 pr-6 py-1 bg-white border border-indigo-100 rounded-lg shadow-sm text-xs font-bold text-indigo-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer appearance-none min-w-[95px] h-8">
                    </select>
                    <i class="fas fa-chevron-down absolute right-2 top-1/2 -translate-y-1/2 text-[9px] text-indigo-300 pointer-events-none"></i>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-2 mb-2">
                
                <div class="bg-white rounded-xl p-2 shadow-sm border border-slate-100 flex flex-col items-center justify-center relative overflow-hidden h-24 sm:h-32">
                    <div class="absolute top-1 right-1 opacity-10"><i class="fas fa-calendar-check text-4xl text-indigo-600"></i></div>
                    <p class="text-[9px] sm:text-xs font-bold text-slate-400 uppercase tracking-wide">รวมเวร</p>
                    <p class="text-2xl sm:text-3xl font-black text-indigo-600 leading-tight my-0.5" id="totalShifts">-</p>
                    <div class="h-1 w-8 bg-indigo-100 rounded-full"><div class="h-full bg-indigo-500 w-2/3 rounded-full"></div></div>
                </div>
                
                <div class="bg-white rounded-xl p-2 shadow-sm border border-slate-100 flex flex-col items-center justify-center relative overflow-hidden h-24 sm:h-32">
                    <div class="absolute top-1 right-1 opacity-10"><i class="fas fa-clock text-4xl text-emerald-600"></i></div>
                    <p class="text-[9px] sm:text-xs font-bold text-slate-400 uppercase tracking-wide">ชั่วโมง</p>
                    <p class="text-2xl sm:text-3xl font-black text-emerald-500 leading-tight my-0.5" id="totalHours">-</p>
                    <div class="h-1 w-8 bg-emerald-100 rounded-full"><div class="h-full bg-emerald-500 w-full rounded-full"></div></div>
                </div>
                
                <div class="bg-white rounded-xl p-2 shadow-sm border border-slate-100 flex flex-col items-center justify-center relative overflow-hidden h-24 sm:h-32">
                    <div class="absolute top-1 right-1 opacity-10"><i class="fas fa-bed text-4xl text-amber-600"></i></div>
                    <p class="text-[9px] sm:text-xs font-bold text-slate-400 uppercase tracking-wide">ลา/ขาด</p>
                    <p class="text-2xl sm:text-3xl font-black text-amber-500 leading-tight my-0.5" id="totalLeaves">-</p>
                    <div class="h-1 w-8 bg-amber-100 rounded-full"><div class="h-full bg-amber-500 w-1/4 rounded-full"></div></div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2 mb-3">
                
                <div class="bg-white rounded-xl p-2 pl-3 shadow-sm border border-slate-100 flex flex-row items-center justify-between relative overflow-hidden h-16 sm:h-20">
                    <div class="absolute -right-2 -bottom-2 opacity-10 rotate-12">
                        <i class="fas fa-exchange-alt text-5xl text-violet-600"></i>
                    </div>
                    <div class="z-10">
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wide">แลกเปลี่ยน</p>
                        <div class="flex items-baseline gap-1">
                            <p class="text-xl sm:text-2xl font-black text-violet-600" id="totalSwaps">-</p>
                            <span class="text-[9px] text-slate-400">ครั้ง</span>
                        </div>
                    </div>
                    <div class="pr-1 z-10">
                        <div class="bg-violet-50 text-violet-600 rounded-lg w-8 h-8 flex items-center justify-center">
                            <i class="fas fa-sync-alt text-xs"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-2 pl-3 shadow-sm border border-slate-100 flex flex-row items-center justify-between relative overflow-hidden h-16 sm:h-20">
                    <div class="absolute -right-2 -bottom-2 opacity-10 rotate-12">
                        <i class="fas fa-hand-holding-dollar text-5xl text-rose-600"></i>
                    </div>
                    <div class="z-10">
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wide">ซื้อ/ขาย</p>
                        <div class="flex items-baseline gap-1">
                            <p class="text-xl sm:text-2xl font-black text-rose-500" id="totalTrades">-</p>
                            <span class="text-[9px] text-slate-400">เวร</span>
                        </div>
                    </div>
                    <div class="pr-1 z-10">
                        <div class="bg-rose-50 text-rose-600 rounded-lg w-8 h-8 flex items-center justify-center">
                            <i class="fas fa-dollar-sign text-xs"></i>
                        </div>
                    </div>
                </div>

            </div>

            <div class="bg-white rounded-t-xl shadow-[0_-4px_15px_rgba(0,0,0,0.03)] border border-slate-100 overflow-hidden flex flex-col h-[calc(100vh-280px)]">
                
                <div class="px-3 py-2 border-b border-slate-50 flex justify-between items-center bg-white sticky top-0 z-20">
                    <h3 class="font-bold text-slate-700 text-xs flex items-center gap-1.5">
                        <i class="fas fa-list text-indigo-500 bg-indigo-50 p-1 rounded"></i> รายละเอียดรายเดือน
                    </h3>
                    <span class="text-[9px] text-slate-400 bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100">แตะเพื่อดูสัปดาห์</span>
                </div>
                
                <div class="overflow-y-auto overflow-x-hidden no-scrollbar flex-1 pb-20"> 
                    <table class="w-full text-xs text-left">
                        <thead class="text-[10px] text-slate-400 font-bold uppercase bg-slate-50/80 border-b border-slate-50 sticky top-0 z-10 backdrop-blur-sm">
                            <tr>
                                <th class="px-3 py-2 w-1/5">เดือน</th>
                                <th class="px-1 py-2 text-center w-1/5">รวม</th>
                                <th class="px-1 py-2 text-center text-emerald-500 w-1/5">เช้า</th>
                                <th class="px-1 py-2 text-center text-orange-400 w-1/5">บ่าย</th>
                                <th class="px-1 py-2 text-center text-blue-400 w-1/5 pr-3">ดึก</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyShiftTableBody" class="divide-y divide-slate-50">
                        </tbody>
                    </table>
                </div>
            </div>

        </div> 

    </app-layout>
    <app-navbar class="sticky top-0 z-30"></app-navbar>
    

<script>
    let currentFetchedData = null; 
    let activeDetailRow = null; 
    const monthNames = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];

    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. ตรวจสอบ User และ Token ---
        const userStr = localStorage.getItem('user');
        const token = localStorage.getItem('authToken');

        if (!userStr || !token) {
            window.location.href = 'login.html';
            return;
        }

        // ตั้งค่าตัวเลือกปี
        const yearSelector = document.getElementById('yearSelector');
        const currentYearAD = new Date().getFullYear();
        const currentYearTH = currentYearAD + 543;
        
        let optionsHTML = '';
        for (let i = 0; i < 6; i++) {
            const yTH = currentYearTH - i;
            optionsHTML += `<option value="${yTH}">ปี ${yTH}</option>`;
        }
        yearSelector.innerHTML = optionsHTML;

        // โหลดข้อมูลครั้งแรก
        updateStatistics(yearSelector.value);

        // Event Listener เปลี่ยนปี
        yearSelector.addEventListener('change', (e) => updateStatistics(e.target.value));
    });

    async function updateStatistics(yearTH) {
        const yearAD = parseInt(yearTH) - 543;
        const tbody = document.getElementById('monthlyShiftTableBody');
        
        // UI: Loading State
        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-10"><i class="fas fa-circle-notch fa-spin text-indigo-200 text-xl"></i></td></tr>`;
        
        // Reset ตัวเลขหน้าจอ
        ['totalShifts', 'totalHours', 'totalLeaves', 'totalSwaps', 'totalTrades'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.textContent = '-';
        });

        try {
            // ดึงข้อมูล User จาก Storage
            const user = JSON.parse(localStorage.getItem('user'));
            const token = localStorage.getItem('authToken'); // ✅ ดึง Token

            // *** API CALL (ใช้ API_BASE จาก components.js) ***
            const response = await fetch(`${API_BASE}/api/my-stats`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` // ✅ แนบ Token
                },
                body: JSON.stringify({ userId: user.UserID, year: yearAD })
            });

            // เช็คกรณี Token หมดอายุ
            if (response.status === 401) {
                localStorage.clear();
                window.location.href = 'login.html';
                return;
            }

            if (!response.ok) throw new Error("Server Error");
            
            const result = await response.json();

            if (result.success) {
                currentFetchedData = result.data;
                updateStatCards(result.data);
                updateMonthlyTable(result.data.monthlyDetails);
            }
        } catch (error) {
            console.error("Error fetching stats:", error);
            tbody.innerHTML = `<tr><td colspan="5" class="text-center py-6 text-red-300 text-[10px]">โหลดข้อมูลไม่สำเร็จ</td></tr>`;
        }
    }

    function updateStatCards(data) {
        document.getElementById('totalShifts').textContent = (data.totalShifts || 0).toLocaleString();
        document.getElementById('totalHours').textContent = (data.totalHours || 0).toLocaleString();
        document.getElementById('totalLeaves').textContent = (data.totalLeaves || 0).toLocaleString();
        document.getElementById('totalSwaps').textContent = (data.totalSwaps || 0).toLocaleString();
        document.getElementById('totalTrades').textContent = (data.totalTrades || 0).toLocaleString();
    }

    function updateMonthlyTable(monthlyDetails) {
        const tbody = document.getElementById('monthlyShiftTableBody');
        tbody.innerHTML = '';

        if(!monthlyDetails || monthlyDetails.length === 0) {
             tbody.innerHTML = `<tr><td colspan="5" class="text-center py-6 text-slate-300 text-[10px]">ไม่มีข้อมูลเวรในปีนี้</td></tr>`;
             return;
        }

        monthlyDetails.forEach((monthData) => {
            const row = document.createElement('tr');
            row.className = "hover:bg-slate-50 cursor-pointer transition-colors group";
            row.onclick = () => toggleWeeklyDetails(row, monthData);

            const mName = monthNames[monthData.month - 1];
            const isZero = monthData.total === 0;
            const opacity = isZero ? 'opacity-30' : 'opacity-100 font-bold';

            row.innerHTML = `
                <td class="px-3 py-2.5 font-medium text-slate-600 group-hover:text-indigo-600">${mName}</td>
                <td class="px-1 py-2.5 text-center"><span class="${isZero ? 'text-slate-200' : 'text-slate-700 bg-slate-100 px-1.5 py-0.5 rounded text-[10px] font-bold'}">${monthData.total}</span></td>
                <td class="px-1 py-2.5 text-center color-shift-a ${opacity}">${monthData.morning}</td>
                <td class="px-1 py-2.5 text-center color-shift-b ${opacity}">${monthData.afternoon}</td>
                <td class="px-1 py-2.5 text-center color-shift-c ${opacity} pr-3">${monthData.night}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function toggleWeeklyDetails(clickedRow, monthData) {
        if (activeDetailRow && activeDetailRow.previousElementSibling === clickedRow) {
            activeDetailRow.remove(); activeDetailRow = null; return;
        }
        if (activeDetailRow) activeDetailRow.remove();

        const weeks = generateWeeklyBreakdown(monthData);
        const newDetailRow = document.createElement('tr');
        newDetailRow.className = 'weekly-detail-row';
        newDetailRow.innerHTML = `<td colspan="5" class="p-0"><div class="bg-slate-50/50 p-2 shadow-inner border-y border-slate-100"><div class="bg-white rounded-lg border border-slate-200 p-2 shadow-sm mx-0">${renderWeeklyTableHTML(weeks)}</div></div></td>`;
        clickedRow.after(newDetailRow);
        activeDetailRow = newDetailRow;
        
        setTimeout(() => {
            newDetailRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
    }

    function renderWeeklyTableHTML(weeks) {
        if (weeks.reduce((a,b) => a + b.total, 0) === 0) return `<div class="text-center text-[9px] text-slate-300 py-1">ไม่มีเวรในเดือนนี้</div>`;
        const rows = weeks.map(w => `<tr class="text-[9px] border-b border-slate-50 last:border-0"><td class="py-1.5 text-slate-400">สัปดาห์ ${w.week}</td><td class="text-center font-bold text-indigo-600">${w.total}</td><td class="text-center color-shift-a">${w.morning}</td><td class="text-center color-shift-b">${w.afternoon}</td><td class="text-center color-shift-c">${w.night}</td></tr>`).join('');
        return `<table class="w-full"><tbody>${rows}</tbody></table>`;
    }

    function generateWeeklyBreakdown(mData) {
        // Logic จำลองการกระจายเวรรายสัปดาห์ (Frontend Simulation)
        const distribute = (total) => {
            let arr = [0,0,0,0], base = Math.floor(total/4), rem = total%4;
            for(let i=0; i<4; i++) arr[i] = base + (i<rem?1:0); return arr;
        };
        const wM = distribute(mData.morning||0), wA = distribute(mData.afternoon||0), wN = distribute(mData.night||0);
        return [1,2,3,4].map((wk, i) => ({ week: wk, morning: wM[i], afternoon: wA[i], night: wN[i], total: wM[i]+wA[i]+wN[i] }));
    }
</script>
</body>
</html>