<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUTONURSESHIFT - ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏ß‡∏£</title>
    
    <link href="./style.css" rel="stylesheet"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/th.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="components.js"></script>
    
    <script>
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Flatpickr ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AppDatePicker
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof flatpickr !== 'undefined' && flatpickr.l10ns.th) {
                flatpickr.localize(flatpickr.l10ns.th); // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
            }
        });
    </script>
</head>
<body class="bg-gray-50 font-sans">
    
    <app-layout>
        <div class="max-w-screen-md mx-auto px-4 md:px-6 pt-6 space-y-8">
            
            <header class="text-center mb-6">
                <h1 class="text-3xl font-bold text-indigo-700">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏ß‡∏£</h1>
                <p class="text-slate-500 mt-2">‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
            </header>

            <section class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                <h2 class="text-xl font-semibold mb-4 text-slate-700">üìÖ ‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</h2>
                <div class="space-y-4">
                    
                    <p class="text-sm text-indigo-600 bg-indigo-50 p-3 rounded-xl border border-indigo-100">
                        <i class="fas fa-info-circle mr-2"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£ **‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ**
                    </p>

                    <div>
                        <label class="text-sm font-medium text-slate-600 block mb-2">‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤:</label>
                        <p id="setting-period-display" class="font-bold text-lg text-indigo-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≠‡∏ö...</p>
                    </div>

                    <hr class="border-slate-100">
                    
                    <div>
                        <label for="desired-days-off" class="text-sm font-medium text-slate-600 block mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏∏‡∏î (Days Off)</label>
                        <div class="flex items-center gap-3">
                            <input type="number" id="desired-days-off" value="4" min="0" max="10" class="w-20 border-2 border-gray-100 rounded-xl p-3 text-sm text-center font-bold focus:border-indigo-500 transition outline-none">
                            <span class="text-slate-500">‡∏ß‡∏±‡∏ô/‡∏£‡∏≠‡∏ö</span>
                        </div>
                        <p class="text-xs text-slate-400 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£‡∏ô‡∏µ‡πâ (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏ß‡∏±‡∏ô)</p>
                    </div>

                    <hr class="border-slate-100">

                    <div>
                        <label class="text-sm font-medium text-slate-600 block mb-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å (‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£)</label>
                        <app-date-picker 
                            placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)" 
                            input-id="fixed-days-off-picker"
                            data-mode="multiple"
                        ></app-date-picker>
                        <p class="text-xs text-slate-400 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô</p>
                    </div>
                </div>
            </section>

            <section class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                <h2 class="text-xl font-semibold mb-4 text-slate-700">‚≠ê ‡∏Å‡∏∞‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£/‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (Preference)</h2>

                <p class="text-sm text-slate-400 mb-4 border-b pb-3 border-slate-100">
                    ‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏∞ (1: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÄ‡∏•‡∏¢, 5: ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
                </p>
                
                <div class="grid grid-cols-3 gap-4">
                    <div id="pref-Morning-input"></div>
                    <div id="pref-Afternoon-input"></div>
                    <div id="pref-Night-input"></div>
                </div>
            </section>

            <footer class="pt-4 pb-8">
                <button id="save-constraints-btn" class="w-full bg-indigo-600 text-white text-lg font-semibold py-3 rounded-2xl shadow-lg shadow-indigo-300 hover:bg-indigo-700 transition-all duration-300">
                    <i class="fas fa-save mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î
                </button>
            </footer>

        </div>
    </app-layout>

<script>
    // Helper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á input Preference
    function ShiftPreferenceInput(shiftId, label) {
        let colorClass = shiftId.includes('Morning') ? 'text-blue-600' : (shiftId.includes('Afternoon') ? 'text-orange-600' : 'text-purple-600');
        return `
            <div class="text-center p-3 rounded-xl border-2 border-slate-200 bg-white shadow-sm hover:border-indigo-400 transition">
                <p class="text-sm font-bold mb-2 ${colorClass}">${label}</p>
                <input type="number" id="pref-${shiftId}" value="3" min="1" max="5" class="w-full border-2 border-gray-100 rounded-lg p-3 text-center text-xl font-bold focus:border-indigo-500 transition outline-none">
                <div class="mt-2 text-xs text-slate-400">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (1-5)</div>
            </div>
        `;
    }
    
    // Logic ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Form
    document.addEventListener('DOMContentLoaded', () => {
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        const user = typeof getUser === 'function' ? getUser() : JSON.parse(localStorage.getItem('user'));
        
        // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á RoleID 1 ‡πÅ‡∏•‡∏∞ 2
        if (!user || ![1, 2].includes(user.RoleID)) {
             console.error("Access Denied: ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
             window.location.href = 'login.html';
             return;
        }

        // 2. Initial Render Preference Inputs
        document.getElementById('pref-Morning-input').innerHTML = ShiftPreferenceInput('Morning', '‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤');
        document.getElementById('pref-Afternoon-input').innerHTML = ShiftPreferenceInput('Afternoon', '‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢');
        document.getElementById('pref-Night-input').innerHTML = ShiftPreferenceInput('Night', '‡∏Å‡∏∞‡∏î‡∏∂‡∏Å');
        
        // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£
        const periodDisplay = document.getElementById('setting-period-display');
        let settingPeriodStart = '';

        if (typeof moment !== 'undefined' && periodDisplay) {
            const nextMonthStart = moment().add(1, 'month').startOf('month');
            const nextMonthEnd = moment().add(1, 'month').endOf('month');
            
            periodDisplay.innerText = `‡∏£‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${nextMonthStart.format('D')} - ${nextMonthEnd.format('D MMMM YYYY')}`;
            settingPeriodStart = nextMonthStart.format('YYYY-MM-DD');
        }

        // 4. Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        const saveBtn = document.getElementById('save-constraints-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', async () => {
                const daysOff = parseInt(document.getElementById('desired-days-off').value) || 0;
                const fixedDaysOffInput = document.getElementById('fixed-days-off-picker');
                const fixedDaysOffString = fixedDaysOffInput ? fixedDaysOffInput.value : '';
                
                const preferences = {
                    Morning: parseInt(document.getElementById('pref-Morning').value) || 3,
                    Afternoon: parseInt(document.getElementById('pref-Afternoon').value) || 3,
                    Night: parseInt(document.getElementById('pref-Night').value) || 3,
                };

                if (daysOff < 0 || daysOff > 10) {
                     Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 0-10 ‡∏ß‡∏±‡∏ô', 'warning');
                     return;
                }
                
                const payload = {
                    userId: user.UserID,
                    settingPeriod: settingPeriodStart,
                    daysOffMinimum: daysOff,
                    fixedDaysOff: fixedDaysOffString.split(',').map(d => d.trim()).filter(d => d), 
                    preferences: preferences
                };

                // 5. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ API
                try {
                    const token = typeof getToken === 'function' ? getToken() : localStorage.getItem('authToken');
                    const API_BASE = typeof window.API_BASE !== 'undefined' ? window.API_BASE : 'http://localhost:3000';
                    
                    const res = await fetch(`${API_BASE}/api/set-constraints`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await res.json();
                    
                    if (res.ok && result.success) {
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success')
                            .then(() => {
                                // ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Dashboard ‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
                                if (user.RoleID === 1) {
                                    window.location.href = 'Headnurse_dashboard.html';
                                } else {
                                    window.location.href = 'dashboard.html';
                                }
                            });
                    } else {
                        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                    }

                } catch (e) {
                    console.error('API Error:', e);
                    Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
                }
            });
        }
    });
</script>
</body>
</html>