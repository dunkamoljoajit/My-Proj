<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Head Nurse Dashboard</title>
    
    <link href="css/style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="lib/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="lib/flatpickr.css">
    
    <script src="lib/flatpickr.js"></script>
    <script src="lib/th.js"></script>
    <script src="components.js"></script>
</head>
<body class="flex flex-col h-screen overflow-hidden">
    <div id="toast-container" class="fixed top-4 right-4 z-[10000] flex flex-col gap-2 pointer-events-none"></div>

    <app-header></app-header>
    
    <main class="flex-1 overflow-y-auto bg-[#f8f9fa] pb-32">
        <div class="max-w-screen-md mx-auto p-4 space-y-6">

            <div class="modern-card p-6 relative">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <i class="fas fa-sliders-h text-violet-600"></i> ตั้งค่าระบบรับเวร
                        </h2>
                        <p class="text-xs text-gray-400 mt-1" id="period-status-text">กำลังตรวจสอบสถานะ...</p>
                    </div>
                    
                    <div class="flex bg-gray-100 p-1 rounded-full">
                        <button onclick="togglePeriod('Open')" id="btn-open" class="toggle-btn toggle-inactive">OPEN</button>
                        <button onclick="togglePeriod('Closed')" id="btn-closed" class="toggle-btn toggle-inactive">CLOSED</button>
                    </div>
                </div>

                <form id="scheduleSettingsForm" class="space-y-6">
                    <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-3 block text-center">จำนวนพยาบาลต่อเวร</label>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="text-center">
                                <div class="text-xs text-gray-500 mb-2 font-medium"><i class="fas fa-sun text-amber-400 mr-1"></i>เช้า</div>
                                <input type="number" id="quotaMorning" class="stat-input w-full" placeholder="0" min="1" required>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500 mb-2 font-medium"><i class="fas fa-cloud-sun text-orange-400 mr-1"></i>บ่าย</div>
                                <input type="number" id="quotaAfternoon" class="stat-input w-full" placeholder="0" min="1" required>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500 mb-2 font-medium"><i class="fas fa-moon text-indigo-400 mr-1"></i>ดึก</div>
                                <input type="number" id="quotaNight" class="stat-input w-full" placeholder="0" min="1" required>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2 block">วันปิดรับข้อมูล (DEADLINE)</label>
                        <div id="date-container" class="relative group">
                            <input type="text" id="deadlineDate" placeholder="เลือกวันที่..." class="w-full bg-white border-2 border-gray-100 rounded-xl px-4 py-3 pl-11 text-sm font-medium text-gray-700 focus:border-violet-500 focus:ring-4 focus:ring-violet-50 transition outline-none cursor-pointer" required>
                            <i class="fas fa-calendar-alt absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-hover:text-violet-500 transition-colors"></i>
                        </div>
                    </div>

                    <button type="submit" id="btn-save-settings" class="btn-primary w-full flex items-center justify-center gap-2">
                        <i class="fas fa-save"></i> บันทึกการตั้งค่า
                    </button>
                </form>
            </div>

            <div class="modern-card p-6 border-l-4 border-amber-400">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="font-bold text-gray-800">ความคืบหน้าการส่งข้อจำกัด</h3>
                        <p class="text-xs text-gray-400 progress-text" id="submission-count-text">กำลังโหลดข้อมูล...</p>
                    </div>
                    <div class="text-right">
                        <span id="submission-percent" class="progress-percent text-2xl font-black text-amber-500">0%</span>
                    </div>
                </div>
                <div class="w-full bg-gray-100 h-2.5 rounded-full overflow-hidden">
                    <div id="submission-bar" class="bg-amber-400 h-full transition-all duration-700" style="width: 0%"></div>
                </div>
            </div>

            <div class="space-y-3">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider ml-1">เมนูจัดการ</h3>
                
                <a href="constraint_settings.html" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between group hover:border-violet-200 transition-all duration-200 cursor-pointer">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-violet-50 rounded-full flex items-center justify-center text-violet-600 group-hover:scale-110 transition-transform">
                            <i class="fas fa-user-clock text-lg"></i>
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <h4 class="text-sm font-bold text-gray-700 group-hover:text-violet-700 transition-colors">ส่งข้อจำกัด (ส่วนตัว)</h4>
                                <span id="my-constraint-status" class="px-2 py-1 rounded bg-gray-100 text-gray-400 text-xs font-bold">รอตรวจสอบ...</span>
                            </div>
                            <p class="text-[10px] text-gray-400">สำหรับหัวหน้าพยาบาล (ต้องส่งทุกรอบ)</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 group-hover:text-violet-500 transition-colors"></i>
                </a>

                <a href="nurse_list.html" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between group hover:border-blue-200 transition-all duration-200 cursor-pointer">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 group-hover:scale-110 transition-transform">
                            <i class="fas fa-users text-lg"></i>
                        </div>
                        <div>
                            <h4 class="text-sm font-bold text-gray-700 group-hover:text-blue-700 transition-colors">รายชื่อพยาบาล</h4>
                            <p class="text-[10px] text-gray-400">จัดการข้อมูลบุคลากร</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 group-hover:text-blue-500 transition-colors"></i>
                </a>

                <a href="admin-import.html" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between group hover:border-green-400 transition-all duration-200 cursor-pointer">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-green-50 rounded-full flex items-center justify-center text-green-600 group-hover:scale-110 transition-transform">
                            <i class="fas fa-file-excel text-lg"></i>
                        </div>
                        <div>
                            <h4 class="text-sm font-bold text-gray-700 group-hover:text-green-700 transition-colors">นำเข้าข้อมูล (Excel)</h4>
                            <p class="text-[10px] text-gray-400">อัปโหลดไฟล์รายชื่อพยาบาล</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 group-hover:text-green-500 transition-colors"></i>
                </a>
            </div>

            <div id="generate-section">
                <a href="generate_schedule.html" id="btn-generate-real" class="hidden bg-gradient-to-r from-fuchsia-600 to-pink-600 text-white p-5 rounded-2xl shadow-lg shadow-fuchsia-200 flex items-center justify-between group hover:scale-[1.02] transition-all cursor-pointer mt-6">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                            <i class="fas fa-wand-magic-sparkles text-xl animate-pulse"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg">สร้างตารางเวร</h4>
                            <p class="text-xs text-fuchsia-100">ข้อมูลครบถ้วน พร้อมประมวลผล</p>
                        </div>
                    </div>
                    <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center group-hover:bg-white group-hover:text-fuchsia-600 transition-colors">
                        <i class="fas fa-arrow-right text-xs"></i>
                    </div>
                </a>

                <div id="btn-generate-locked" class="bg-white border-2 border-dashed border-gray-200 p-5 rounded-2xl flex items-center justify-between text-gray-400 mt-6">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-gray-50 rounded-full flex items-center justify-center">
                            <i class="fas fa-lock"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg text-gray-500">ระบบยังไม่พร้อมจัดเวร</h4>
                            <p class="text-xs" id="locked-reason">รอปิดรับข้อมูลและตรวจสอบความครบถ้วน</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="status-bar-container" class="text-center py-4">
                <span class="inline-flex items-center px-3 py-1 rounded-full bg-gray-100 text-gray-500 text-xs font-medium border border-gray-200">
                    <i class="fas fa-circle-notch fa-spin mr-2 text-violet-500"></i> <span id="status-bar-text">กำลังเชื่อมต่อฐานข้อมูล...</span>
                </span>
            </div>
        </div>
    </main>

    <app-navbar></app-navbar>

    <script>
        const API_URL = (typeof API_BASE !== 'undefined') ? API_BASE : 'http://localhost:3000';
        let isWindowOpen = false;
        let isSubmissionComplete = false;

        document.addEventListener('DOMContentLoaded', () => {
            checkHeadNurseRole();
            setupCalendar();
            loadAllData();
            
            // ✅ เรียกดึงข้อมูลสถานะการส่งข้อจำกัดทันที
            updateConstraintStatus();
        });

        // ✅ ฟังก์ชันดึงสถานะการส่งข้อจำกัด (Progress + Personal Status)
        async function updateConstraintStatus() {
            try {
                const token = localStorage.getItem('authToken');
                const res = await fetch(`${API_URL}/api/constraint-status`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (data.success) {
                    // 1. อัปเดต Progress
                    const progressText = document.querySelector('.progress-text');
                    if (progressText) {
                        progressText.innerText = `ส่งแล้ว ${data.submitted} จากพยาบาลทั้งหมด ${data.total} คน`;
                    }
                    
                    const percent = Math.round((data.submitted / data.total) * 100) || 0;
                    const percentText = document.querySelector('.progress-percent');
                    if (percentText) percentText.innerText = `${percent}%`;
                    
                    const progressBar = document.getElementById('submission-bar');
                    if (progressBar) progressBar.style.width = `${percent}%`;

                    // 2. อัปเดต Badge ส่วนตัว
                    const statusBadge = document.getElementById('my-constraint-status');
                    if (statusBadge) {
                        if (data.myStatus) {
                            statusBadge.innerText = 'ส่งแล้ว';
                            statusBadge.className = 'px-2 py-1 rounded bg-green-100 text-green-600 text-xs font-bold';
                        } else {
                            statusBadge.innerText = 'ยังไม่ส่ง';
                            statusBadge.className = 'px-2 py-1 rounded bg-red-100 text-red-600 text-xs font-bold';
                        }
                    }
                }
            } catch (err) {
                console.error("Load Constraint Status Error:", err);
            }
        }

        function checkHeadNurseRole() {
            try {
                const userStr = localStorage.getItem('user');
                if (!userStr) throw new Error("No user found");
                const user = JSON.parse(userStr);
                if (user.RoleID !== 1) throw new Error("Unauthorized");
            } catch (e) {
                localStorage.clear();
                window.location.href = 'login.html';
            }
        }

        function setupCalendar() {
            flatpickr("#deadlineDate", { locale:"th", dateFormat:"Y-m-d", altInput:true, altFormat:"j F Y", disableMobile:true, appendTo:document.getElementById('date-container') });
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) { console.error("Error: Toast container not found"); return; }

            const toast = document.createElement('div');
            const bgClass = type === 'success' ? 'bg-emerald-500' : (type === 'error' ? 'bg-rose-500' : 'bg-amber-500');
            const iconClass = type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-times-circle' : 'fa-info-circle');

            toast.className = `toast pointer-events-auto flex items-center w-full max-w-xs p-4 text-white rounded-xl shadow-lg ${bgClass} mb-2 transform transition-all duration-300 translate-x-full`;
            toast.innerHTML = `
                <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-${type === 'warning' ? 'amber' : 'white'} bg-white/20 rounded-lg">
                    <i class="fas ${iconClass}"></i>
                </div>
                <div class="ml-3 text-sm font-medium break-words">${message}</div>
                <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-white/10 text-white rounded-lg p-1.5 hover:bg-white/20 inline-flex h-8 w-8" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(toast);
            requestAnimationFrame(() => { toast.classList.remove('translate-x-full'); });
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function loadAllData() {
            const token = localStorage.getItem('authToken');
            const statusBarText = document.getElementById('status-bar-text');

            try {
                const [settingsRes, statusRes, pendingRes] = await Promise.all([
                    fetch(`${API_URL}/api/admin/get-settings`, {headers:{'Authorization':`Bearer ${token}`}}),
                    fetch(`${API_URL}/api/check-constraint-window`, {headers:{'Authorization':`Bearer ${token}`}}),
                    fetch(`${API_URL}/api/admin/pending-counts`, {headers:{'Authorization':`Bearer ${token}`}})
                ]);

                const settings = await settingsRes.json();
                const status = await statusRes.json();
                isWindowOpen = status.isOpen;

                // Auto Close Logic
                if (settings.success && settings.settings && settings.settings.deadline && isWindowOpen) {
                    const deadlineDate = new Date(settings.settings.deadline);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    deadlineDate.setHours(0, 0, 0, 0);

                    if (today > deadlineDate) {
                        console.log("Deadline exceeded. Auto-closing...");
                        await fetch(`${API_URL}/api/admin/toggle-window`, { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, 
                            body: JSON.stringify({ status: 'Closed' }) 
                        });
                        isWindowOpen = false;
                    }
                }

                if(settings.success && settings.settings) {
                    document.getElementById('quotaMorning').value = settings.settings.morning;
                    document.getElementById('quotaAfternoon').value = settings.settings.afternoon;
                    document.getElementById('quotaNight').value = settings.settings.night;
                    if(settings.settings.deadline) document.getElementById("deadlineDate")._flatpickr.setDate(settings.settings.deadline, true);
                }

                updatePeriodUI(isWindowOpen);

                const pending = await pendingRes.json();
                if(pending.success) {
                    document.getElementById('pending-swap-count').innerText = pending.swapCount;
                    document.getElementById('pending-trade-count').innerText = pending.tradeCount;
                }

                checkGenerateEligibility();
                statusBarText.innerText = "ข้อมูลล่าสุด";
            } catch(e) { 
                statusBarText.innerText = "เกิดข้อผิดพลาดในการเชื่อมต่อ"; 
                statusBarText.classList.add('text-red-500'); 
            }
        }

        function checkGenerateEligibility() {
            const btnReal = document.getElementById('btn-generate-real');
            const btnLocked = document.getElementById('btn-generate-locked');
            const lockedReason = document.getElementById('locked-reason');
            
            // Logic คร่าวๆ (อาจต้องปรับตาม isSubmissionComplete จริงๆ)
            if (!isWindowOpen) {
                btnReal.classList.remove('hidden'); btnLocked.classList.add('hidden');
            } else {
                btnReal.classList.add('hidden'); btnLocked.classList.remove('hidden');
                lockedReason.innerText = "กรุณากด CLOSED ระบบเพื่อปิดรับข้อมูลก่อนจัดเวร";
            }
        }

        function updatePeriodUI(isOpen) {
            const btnOpen = document.getElementById('btn-open');
            const btnClosed = document.getElementById('btn-closed');
            const statusText = document.getElementById('period-status-text');
            const saveBtn = document.getElementById('btn-save-settings');
            const inputs = document.querySelectorAll('#scheduleSettingsForm input');
            
            btnOpen.className = isOpen ? 'toggle-btn toggle-active-open' : 'toggle-btn toggle-inactive';
            btnClosed.className = !isOpen ? 'toggle-btn toggle-active-closed' : 'toggle-btn toggle-inactive';
            
            if(isOpen) {
                statusText.innerHTML = '<span class="text-emerald-500 font-bold">● เปิดรับข้อมูล</span>';
                inputs.forEach(el => el.disabled = true);
                saveBtn.disabled = true; saveBtn.classList.remove('btn-primary'); saveBtn.classList.add('btn-disabled');
                saveBtn.innerHTML = '<i class="fas fa-lock"></i> ระบบเปิดอยู่ (ล็อกการแก้ไข)';
            } else {
                statusText.innerHTML = '<span class="text-rose-500 font-bold">● ปิดรับข้อมูล</span>';
                inputs.forEach(el => el.disabled = false);
                saveBtn.disabled = false; saveBtn.classList.remove('btn-disabled'); saveBtn.classList.add('btn-primary');
                saveBtn.innerHTML = '<i class="fas fa-save"></i> บันทึกการตั้งค่า';
            }
            checkGenerateEligibility();
        }

        async function togglePeriod(status) {
            if(!confirm(`ยืนยันการ "${status==='Open'?'เปิด':'ปิด'}" ระบบ?\n\n${status==='Open' ? 'พยาบาลจะสามารถส่งเวรได้ และคุณจะแก้ไขค่าไม่ได้' : 'พยาบาลจะส่งเวรไม่ได้อีก และคุณสามารถสั่งจัดเวรได้'}`)) return;
            const res = await fetch(`${API_URL}/api/admin/toggle-window`, { method:'POST', headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${localStorage.getItem('authToken')}`}, body:JSON.stringify({status}) });
            if(res.ok) {
                loadAllData();
                updateConstraintStatus(); // อัปเดตสถานะด้วย
            }
        }

        document.getElementById('scheduleSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!confirm('ยืนยันการ "บันทึกและเปิดระบบ"?\n\nเมื่อกดตกลง:\n1. ข้อมูลจะถูกบันทึก\n2. ระบบจะเปลี่ยนสถานะเป็น OPEN\n3. การตั้งค่าจะถูกล็อกทันที')) return;

            const saveBtn = document.getElementById('btn-save-settings');
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true; 
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังดำเนินการ...';

            const m = document.getElementById('quotaMorning').value;
            const a = document.getElementById('quotaAfternoon').value;
            const n = document.getElementById('quotaNight').value;
            const d = document.getElementById('deadlineDate').value;
            const token = localStorage.getItem('authToken');

            try {
                const saveRes = await fetch(`${API_URL}/api/admin/save-settings`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`}, 
                    body: JSON.stringify({morning: m, afternoon: a, night: n, deadline: d}) 
                });
                const saveResult = await saveRes.json();

                if(!saveResult.success) throw new Error('บันทึกข้อมูลไม่สำเร็จ: ' + saveResult.message);

                const openRes = await fetch(`${API_URL}/api/admin/toggle-window`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`}, 
                    body: JSON.stringify({ status: 'Open' }) 
                });

                if(openRes.ok) {
                    showToast('บันทึกและเปิดระบบเรียบร้อย!', 'success');
                    await loadAllData(); 
                } else {
                    throw new Error('บันทึกข้อมูลสำเร็จ แต่เปิดระบบล้มเหลว');
                }
            } catch(e) {
                console.error(e);
                showToast(e.message, 'error');
                saveBtn.disabled = false; 
                saveBtn.innerHTML = originalText;
            }
        });
    </script>
</body>
</html>