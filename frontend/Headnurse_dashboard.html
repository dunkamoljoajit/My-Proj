<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Head Nurse Dashboard</title>
    <script src="lib/tailwindcss.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="lib/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="lib/flatpickr.css">
    <script src="lib/flatpickr.js"></script>
    <script src="lib/th.js"></script>
    <script src="components.js"></script>

    <style type="text/tailwindcss">
        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: #f3f4f6; 
            color: #374151;
        }
        .modern-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #f9fafb;
        }
        .toggle-btn {
            @apply px-4 py-1.5 rounded-full text-xs font-bold transition-all duration-300;
        }
        .toggle-active-open {
            background-color: #10b981; color: white; box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
        }
        .toggle-active-closed {
            background-color: #ef4444; color: white; box-shadow: 0 2px 10px rgba(239, 68, 68, 0.3);
        }
        .toggle-inactive {
            color: #9ca3af; background-color: transparent;
        }
        .stat-input {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: #4b5563;
            border: 2px solid #f3f4f6;
            border-radius: 16px;
            padding: 12px;
            transition: all 0.2s;
        }
        .stat-input:focus {
            outline: none;
            border-color: #8b5cf6;
            background-color: #fff;
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
        }
        .btn-primary {
            background: linear-gradient(to right, #8b5cf6, #7c3aed);
            color: white;
            font-weight: 600;
            border-radius: 16px;
            padding: 14px;
            transition: transform 0.1s;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
        }
        .btn-disabled {
            background: white !important;
            color: #9ca3af !important;
            cursor: not-allowed;
            box-shadow: none;
            transform: none !important;
            border: 1px solid #e5e7eb;
        }
        .btn-primary:active { transform: scale(0.98); }
        .animate-fade-in-up { animation: fadeInUp 0.2s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <app-header></app-header>

    <main class="flex-1 overflow-y-auto bg-[#f8f9fa] pb-32">
        <div class="max-w-screen-md mx-auto p-4 space-y-6">

            <div class="modern-card p-6 relative">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <i class="fas fa-sliders-h text-violet-600"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏£
                        </h2>
                        <p class="text-xs text-gray-400 mt-1" id="period-status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...</p>
                    </div>
                    
                    <div class="flex bg-gray-100 p-1 rounded-full">
                        <button onclick="togglePeriod('Open')" id="btn-open" class="toggle-btn toggle-inactive">OPEN</button>
                        <button onclick="togglePeriod('Closed')" id="btn-closed" class="toggle-btn toggle-inactive">CLOSED</button>
                    </div>
                </div>

                <form id="scheduleSettingsForm" class="space-y-6">
                    <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-3 block text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏£</label>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="text-center">
                                <div class="text-xs text-gray-500 mb-2 font-medium"><i class="fas fa-sun text-amber-400 mr-1"></i>‡πÄ‡∏ä‡πâ‡∏≤</div>
                                <input type="number" id="quotaMorning" class="stat-input w-full" placeholder="0" min="1" required>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500 mb-2 font-medium"><i class="fas fa-cloud-sun text-orange-400 mr-1"></i>‡∏ö‡πà‡∏≤‡∏¢</div>
                                <input type="number" id="quotaAfternoon" class="stat-input w-full" placeholder="0" min="1" required>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500 mb-2 font-medium"><i class="fas fa-moon text-indigo-400 mr-1"></i>‡∏î‡∏∂‡∏Å</div>
                                <input type="number" id="quotaNight" class="stat-input w-full" placeholder="0" min="1" required>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2 block">‡∏ß‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (DEADLINE)</label>
                        <div id="date-container" class="relative group">
                            <input type="text" id="deadlineDate" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà..." class="w-full bg-white border-2 border-gray-100 rounded-xl px-4 py-3 pl-11 text-sm font-medium text-gray-700 focus:border-violet-500 focus:ring-4 focus:ring-violet-50 transition outline-none cursor-pointer" required>
                            <i class="fas fa-calendar-alt absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-hover:text-violet-500 transition-colors"></i>
                        </div>
                    </div>

                    <button type="submit" id="btn-save-settings" class="btn-primary w-full flex items-center justify-center gap-2">
                        <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                    </button>
                </form>
            </div>

            <div class="modern-card p-6 border-l-4 border-amber-400">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="font-bold text-gray-800">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î</h3>
                        <p class="text-xs text-gray-400" id="submission-count-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                    <div class="text-right">
                        <span id="submission-percent" class="text-2xl font-black text-amber-500">0%</span>
                    </div>
                </div>
                <div class="w-full bg-gray-100 h-2.5 rounded-full overflow-hidden">
                    <div id="submission-bar" class="bg-amber-400 h-full transition-all duration-700" style="width: 0%"></div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <a href="approve_swap.html" class="modern-card p-5 relative overflow-hidden group cursor-pointer block hover:-translate-y-1 transition-transform">
                    <div class="flex justify-between items-start">
                        <div class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-lg">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <span class="bg-emerald-50 text-emerald-600 text-[10px] font-bold px-2 py-1 rounded-full">Swap</span>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-3xl font-bold text-gray-800" id="pending-swap-count">-</h3>
                        <p class="text-xs text-gray-400 font-medium">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡∏Å‡πÄ‡∏ß‡∏£</p>
                    </div>
                </a>

                <a href="approve_trade.html" class="modern-card p-5 relative overflow-hidden group cursor-pointer block hover:-translate-y-1 transition-transform">
                    <div class="flex justify-between items-start">
                        <div class="w-10 h-10 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center text-lg">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                        <span class="bg-amber-50 text-amber-600 text-[10px] font-bold px-2 py-1 rounded-full">Trade</span>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-3xl font-bold text-gray-800" id="pending-trade-count">-</h3>
                        <p class="text-xs text-gray-400 font-medium">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</p>
                    </div>
                </a>
            </div>

            <div class="space-y-3">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider ml-1">‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h3>
                
                <a href="constraint_settings.html" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between group hover:border-violet-200 transition-all duration-200 cursor-pointer">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-violet-50 rounded-full flex items-center justify-center text-violet-600 group-hover:scale-110 transition-transform">
                            <i class="fas fa-user-clock text-lg"></i>
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <h4 class="text-sm font-bold text-gray-700 group-hover:text-violet-700 transition-colors">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î (‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß)</h4>
                                <span id="my-submission-badge" class="hidden px-2 py-0.5 rounded-full text-[9px] font-bold"></span>
                            </div>
                            <p class="text-[10px] text-gray-400">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• (‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö)</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 group-hover:text-violet-500 transition-colors"></i>
                </a>

                <a href="nurse_list.html" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between group hover:border-blue-200 transition-all duration-200 cursor-pointer">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 group-hover:scale-110 transition-transform">
                            <i class="fas fa-users text-lg"></i>
                        </div>
                        <div>
                            <h4 class="text-sm font-bold text-gray-700 group-hover:text-blue-700 transition-colors">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</h4>
                            <p class="text-[10px] text-gray-400">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 group-hover:text-blue-500 transition-colors"></i>
                </a>
                <a href="admin-import.html" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between group hover:border-green-400 transition-all duration-200 cursor-pointer">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-green-50 rounded-full flex items-center justify-center text-green-600 group-hover:scale-110 transition-transform">
                        <i class="fas fa-file-excel text-lg"></i>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-gray-700 group-hover:text-green-700 transition-colors">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Excel)</h4>
                        <p class="text-[10px] text-gray-400">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</p>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-gray-300 group-hover:text-green-500 transition-colors"></i>
            </a>
            </div>

            <div id="generate-section">
                <a href="generate_schedule.html" id="btn-generate-real" class="hidden bg-gradient-to-r from-fuchsia-600 to-pink-600 text-white p-5 rounded-2xl shadow-lg shadow-fuchsia-200 flex items-center justify-between group hover:scale-[1.02] transition-all cursor-pointer mt-6">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                            <i class="fas fa-wand-magic-sparkles text-xl animate-pulse"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£</h4>
                            <p class="text-xs text-fuchsia-100">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</p>
                        </div>
                    </div>
                    <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center group-hover:bg-white group-hover:text-fuchsia-600 transition-colors">
                        <i class="fas fa-arrow-right text-xs"></i>
                    </div>
                </a>

                <div id="btn-generate-locked" class="bg-white border-2 border-dashed border-gray-200 p-5 rounded-2xl flex items-center justify-between text-gray-400 mt-6">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-gray-50 rounded-full flex items-center justify-center">
                            <i class="fas fa-lock"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg text-gray-500">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£</h4>
                            <p class="text-xs" id="locked-reason">‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="status-bar-container" class="text-center py-4">
                <span class="inline-flex items-center px-3 py-1 rounded-full bg-gray-100 text-gray-500 text-xs font-medium border border-gray-200">
                    <i class="fas fa-circle-notch fa-spin mr-2 text-violet-500"></i> <span id="status-bar-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
                </span>
            </div>
        </div>
    </main>

    <app-navbar></app-navbar>

    <script>
        const API_URL = (typeof API_BASE !== 'undefined') ? API_BASE : 'http://localhost:3000';
        let isWindowOpen = false;
        let isSubmissionComplete = false;

        document.addEventListener('DOMContentLoaded', () => {
            checkHeadNurseRole();
            // setupMenu(); // ‚ùå ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ app-header ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß
            // updateDate(); // ‚ùå ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ app-header ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß
            setupCalendar();
            loadAllData();
        });

        // üü† ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Badge
        function updateMySubmissionBadge(hasSubmitted) {
            const badge = document.getElementById('my-submission-badge');
            if(!badge) return;
            badge.classList.remove('hidden', 'bg-emerald-100', 'text-emerald-600', 'bg-rose-100', 'text-rose-600');
            badge.classList.add('block');
            
            if(hasSubmitted) {
                badge.innerText = '‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß';
                badge.classList.add('bg-emerald-100', 'text-emerald-600');
            } else {
                badge.innerText = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á';
                badge.classList.add('bg-rose-100', 'text-rose-600');
            }
        }

        function checkHeadNurseRole() {
            try {
                const userStr = localStorage.getItem('user');
                if (!userStr) throw new Error("No user found");
                const user = JSON.parse(userStr);
                if (user.RoleID !== 1) throw new Error("Unauthorized");
                
                // ‚ùå ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ header ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡πÄ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
                // document.getElementById('admin-name').innerText = `${user.FirstName} ${user.LastName}`;
                // ... code ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ...
            } catch (e) {
                localStorage.clear();
                window.location.href = 'login.html';
            }
        }

        function setupCalendar() {
            flatpickr("#deadlineDate", { locale:"th", dateFormat:"Y-m-d", altInput:true, altFormat:"j F Y", disableMobile:true, appendTo:document.getElementById('date-container') });
        }

        async function loadAllData() {
            const token = localStorage.getItem('authToken');
            const statusBarText = document.getElementById('status-bar-text');

            try {
                const [settingsRes, statusRes, pendingRes, submissionRes] = await Promise.all([
                    fetch(`${API_URL}/api/admin/get-settings`, {headers:{'Authorization':`Bearer ${token}`}}),
                    fetch(`${API_URL}/api/check-constraint-window`, {headers:{'Authorization':`Bearer ${token}`}}),
                    fetch(`${API_URL}/api/admin/pending-counts`, {headers:{'Authorization':`Bearer ${token}`}}),
                    fetch(`${API_URL}/api/admin/check-submission-status`, {headers:{'Authorization':`Bearer ${token}`}})
                ]);

                const settings = await settingsRes.json();
                const status = await statusRes.json();
                isWindowOpen = status.isOpen;

                // --- üü¢ ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°: AUTO CLOSE LOGIC ---
                if (settings.success && settings.settings && settings.settings.deadline && isWindowOpen) {
                    const deadlineDate = new Date(settings.settings.deadline);
                    const today = new Date();
                    
                    // ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ß‡∏•‡∏≤ 00:00)
                    today.setHours(0, 0, 0, 0);
                    deadlineDate.setHours(0, 0, 0, 0);

                    if (today > deadlineDate) {
                        console.log("‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î Deadline ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...");
                        await fetch(`${API_URL}/api/admin/toggle-window`, { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, 
                            body: JSON.stringify({ status: 'Closed' }) 
                        });
                        isWindowOpen = false; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    }
                }
                // ------------------------------------

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
                if(settings.success && settings.settings) {
                    document.getElementById('quotaMorning').value = settings.settings.morning;
                    document.getElementById('quotaAfternoon').value = settings.settings.afternoon;
                    document.getElementById('quotaNight').value = settings.settings.night;
                    if(settings.settings.deadline) document.getElementById("deadlineDate")._flatpickr.setDate(settings.settings.deadline, true);
                }

                updatePeriodUI(isWindowOpen);

                const pending = await pendingRes.json();
                if(pending.success) {
                    document.getElementById('pending-swap-count').innerText = pending.swapCount;
                    document.getElementById('pending-trade-count').innerText = pending.tradeCount;
                }

                const submission = await submissionRes.json();
                if(submission.success) {
                    const { submittedCount, totalNurses, hasAdminSubmitted } = submission;
                    isSubmissionComplete = submittedCount >= totalNurses;
                    const percent = totalNurses > 0 ? Math.round((submittedCount / totalNurses) * 100) : 0;
                    document.getElementById('submission-count-text').innerText = `‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ${submittedCount} ‡∏à‡∏≤‡∏Å‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalNurses} ‡∏Ñ‡∏ô`;
                    document.getElementById('submission-percent').innerText = `${percent}%`;
                    document.getElementById('submission-bar').style.width = `${percent}%`;
                    updateMySubmissionBadge(hasAdminSubmitted);
                }

                checkGenerateEligibility();
                statusBarText.innerText = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î";
            } catch(e) { 
                statusBarText.innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠"; 
                statusBarText.classList.add('text-red-500'); 
            }
        }
        function checkGenerateEligibility() {
            const btnReal = document.getElementById('btn-generate-real');
            const btnLocked = document.getElementById('btn-generate-locked');
            const lockedReason = document.getElementById('locked-reason');
            if (!isWindowOpen && isSubmissionComplete) {
                btnReal.classList.remove('hidden'); btnLocked.classList.add('hidden');
            } else {
                btnReal.classList.add('hidden'); btnLocked.classList.remove('hidden');
                if (isWindowOpen) lockedReason.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î CLOSED ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£";
                else if (!isSubmissionComplete) lockedReason.innerText = "‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏¢‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏î‡πâ";
            }
        }

        function updatePeriodUI(isOpen) {
            const btnOpen = document.getElementById('btn-open');
            const btnClosed = document.getElementById('btn-closed');
            const statusText = document.getElementById('period-status-text');
            const saveBtn = document.getElementById('btn-save-settings');
            const inputs = document.querySelectorAll('#scheduleSettingsForm input');
            btnOpen.className = isOpen ? 'toggle-btn toggle-active-open' : 'toggle-btn toggle-inactive';
            btnClosed.className = !isOpen ? 'toggle-btn toggle-active-closed' : 'toggle-btn toggle-inactive';
            if(isOpen) {
                statusText.innerHTML = '<span class="text-emerald-500 font-bold">‚óè ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>';
                inputs.forEach(el => el.disabled = true);
                saveBtn.disabled = true; saveBtn.classList.remove('btn-primary'); saveBtn.classList.add('btn-disabled');
                saveBtn.innerHTML = '<i class="fas fa-lock"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà (‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)';
            } else {
                statusText.innerHTML = '<span class="text-rose-500 font-bold">‚óè ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>';
                inputs.forEach(el => el.disabled = false);
                saveBtn.disabled = false; saveBtn.classList.remove('btn-disabled'); saveBtn.classList.add('btn-primary');
                saveBtn.innerHTML = '<i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤';
            }
            checkGenerateEligibility();
        }

        async function togglePeriod(status) {
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ "${status==='Open'?'‡πÄ‡∏õ‡∏¥‡∏î':'‡∏õ‡∏¥‡∏î'}" ‡∏£‡∏∞‡∏ö‡∏ö?\n\n${status==='Open' ? '‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏£‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ' : '‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏à‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏£‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏±‡πà‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£‡πÑ‡∏î‡πâ'}`)) return;
            const res = await fetch(`${API_URL}/api/admin/toggle-window`, { method:'POST', headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${localStorage.getItem('authToken')}`}, body:JSON.stringify({status}) });
            if(res.ok) loadAllData();
        }

        document.getElementById('scheduleSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const saveBtn = document.getElementById('btn-save-settings');
            saveBtn.disabled = true; saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            const m = document.getElementById('quotaMorning').value;
            const a = document.getElementById('quotaAfternoon').value;
            const n = document.getElementById('quotaNight').value;
            const d = document.getElementById('deadlineDate').value;
            const res = await fetch(`${API_URL}/api/admin/save-settings`, { method:'POST', headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${localStorage.getItem('authToken')}`}, body:JSON.stringify({morning:m, afternoon:a, night:n, deadline:d}) });
            const result = await res.json();
            if(result.success) { alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!'); loadAllData(); }
            else { alert('Error: ' + result.message); }
            saveBtn.disabled = false; saveBtn.innerHTML = '<i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤';
        });
    </script>
</body>
</html>